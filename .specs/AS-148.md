# CODE SPEC — AS-148 · Policy & PII Gateway (DR_TRACK_A)

## Goal
Detect & redact PII **before logging** and (conditionally) **before model input**. Fail-closed on detector errors. Emit `policy_verdict` + `redaction_stats` into `route_explain` for replay.

## Acceptance Criteria (must all pass)
- 0 PII in logs on a 1,000-run smoke set.
- ≥99% detection for emails/phones on labeled sample (precision ≥97%).
- Redaction stage p95 latency < 50 ms/msg.
- `route_explain` includes {policy_verdict, redaction_stats} for 100% of processed messages.

## Code Targets
- service/policy/policy_gateway.py
- service/policy/redaction.py
- tests/test_policy_pii_gateway.py

## Design Notes
- **Detectors**: regex (RFC5322-lite emails, E.164 phones) + optional NER pass; configurable.
- **Masking**: format-preserving (e.g., "a***@b***.com", "+1-***-***-1234"); keep token shapes.
- **Hooks**:
  - pre-log: ALWAYS mask.
  - pre-model: CONDITIONAL (`enable_input_redaction: bool`).
- **Fail-closed**: if detector throws or times out -> block logging of raw text; record error; continue with masked or empty fields.
- **Telemetry**: count hits per type; record ms timings; expose in `route_explain`.

## Config (YAML)
policy_gateway:
  enable_input_redaction: true
  detectors:
    email: true
    phone: true
  latency_budget_ms_p95: 50
  ner_provider: "none"  # "spacy" or "none"
  fail_closed: true

## Tests (must add)
- tests/test_policy_pii_gateway.py
  - test_email_masking / test_phone_masking (positive + negative)
  - test_fail_closed_blocks_raw_logging
  - test_latency_budget_p95_under_50ms (synthetic 1k loop)
  - test_route_explain_fields_present
