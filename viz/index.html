<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Telemetry Viz</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#input { width: 100%; height: 120px; }
canvas { border: 1px solid #ccc; margin-top: 10px; }
</style>
</head>
<body>
<h1>Telemetry Viz</h1>
<p>Paste telemetry JSONL or load a file to visualize run summaries and SAFE-OUT routes.</p>
<input type="file" id="file" />
<br />
<textarea id="input" placeholder="paste JSONL here"></textarea>
<br />
<button id="render">Render</button>
<button id="export">Export</button>
<canvas id="chart" width="400" height="200"></canvas>
<div id="tables"></div>
<script>
function parseLines(text){
  return text.trim().split(/\n+/).map(l=>{try{return JSON.parse(l);}catch{return null;}}).filter(Boolean);
}
function render(){
  const text=document.getElementById('input').value;
  const events=parseLines(text);
  const ctx=document.getElementById('chart').getContext('2d');
  ctx.clearRect(0,0,400,200);
  const summary=events.find(e=>e.event==='run_summary');
  const conf=summary?summary.final_confidence:0;
  ctx.fillStyle='#69c';
  ctx.fillRect(50,200-conf*180,50,conf*180);
  ctx.strokeRect(50,20,50,180);
  document.getElementById('tables').innerHTML='';
  const so=events.filter(e=>e.event==='safe_out_decision');
  if(so.length){
    const t=document.createElement('table');
    const h=document.createElement('tr');
    h.innerHTML='<th>route</th><th>reason</th>';
    t.appendChild(h);
    so.forEach(ev=>{const r=document.createElement('tr');r.innerHTML='<td>'+ev.route+'</td><td>'+ev.reason+'</td>';t.appendChild(r);});
    document.getElementById('tables').appendChild(t);
  }
}
document.getElementById('render').onclick=render;
document.getElementById('file').onchange=e=>{
  const reader=new FileReader();
  reader.onload=ev=>{document.getElementById('input').value=ev.target.result; render();};
  reader.readAsText(e.target.files[0]);
};
document.getElementById('export').onclick=()=>{
  const link=document.createElement('a');
  link.download='viz.png';
  link.href=document.getElementById('chart').toDataURL('image/png');
  link.click();
};
</script>
<p><a href="../scripts/telemetry_leaderboard.py">Telemetry leaderboard script</a></p>
</body>
</html>
