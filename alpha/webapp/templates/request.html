<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Alpha Solver · Request Submission</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        line-height: 1.5;
      }
      body {
        margin: 0;
        background: radial-gradient(circle at top, #f5f7ff, #e4e7f2);
        min-height: 100vh;
        color: #1a1c2d;
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 3rem 1.5rem 4rem;
      }
      h1 {
        margin-bottom: 1rem;
        font-size: 2rem;
      }
      form {
        display: grid;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 20px 60px rgba(31, 35, 71, 0.08);
        backdrop-filter: blur(12px);
      }
      label {
        font-weight: 600;
        font-size: 0.95rem;
      }
      textarea {
        width: 100%;
        resize: vertical;
        min-height: 140px;
        border-radius: 12px;
        border: 1px solid #cdd5ef;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        color: inherit;
        background: rgba(255, 255, 255, 0.7);
        box-shadow: inset 0 1px 2px rgba(45, 55, 105, 0.05);
      }
      select,
      button {
        font-size: 1rem;
        padding: 0.65rem 0.9rem;
        border-radius: 10px;
        border: 1px solid #cdd5ef;
        background: #ffffff;
        color: inherit;
      }
      button {
        cursor: pointer;
        border: none;
        background: linear-gradient(135deg, #445df5, #8261f7);
        color: #fff;
        font-weight: 600;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 30px rgba(68, 93, 245, 0.25);
      }
      section {
        margin-top: 2rem;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 20px 60px rgba(31, 35, 71, 0.06);
      }
      section[hidden] {
        display: none;
      }
      dl {
        margin: 0;
        display: grid;
        gap: 0.75rem;
      }
      dt {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #5a60a1;
      }
      dd {
        margin: 0;
        font-size: 1rem;
      }
      .error {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        background: rgba(244, 67, 54, 0.12);
        color: #c62828;
        border: 1px solid rgba(244, 67, 54, 0.2);
      }
      @media (max-width: 600px) {
        .container {
          padding: 2rem 1rem 3rem;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Submit a request</h1>
      <form id="request-form" autocomplete="off">
        <div>
          <label for="prompt">Prompt</label>
          <textarea id="prompt" name="prompt" placeholder="Describe the task you want Alpha Solver to run" required></textarea>
        </div>
        <div>
          <label for="provider">Provider</label>
          <select id="provider" name="provider">
            {{provider_options}}
          </select>
        </div>
        <div>
          <button type="submit">Submit request</button>
        </div>
      </form>
      <section id="ack" hidden>
        <h2>Submission</h2>
        <dl>
          <div>
            <dt>Request ID</dt>
            <dd id="request-id">—</dd>
          </div>
          <div>
            <dt>Ack latency</dt>
            <dd><span id="ack-ms">—</span> ms</dd>
          </div>
        </dl>
      </section>
      <section id="status" hidden>
        <h2>Status</h2>
        <dl>
          <div>
            <dt>State</dt>
            <dd id="status-value">pending</dd>
          </div>
          <div>
            <dt>Provider</dt>
            <dd id="status-provider">—</dd>
          </div>
          <div>
            <dt>Latency</dt>
            <dd id="status-latency">—</dd>
          </div>
          <div>
            <dt>Cache hit</dt>
            <dd id="status-cache">—</dd>
          </div>
        </dl>
      </section>
      <div id="error" class="error" role="alert" hidden></div>
    </main>
    <script>
      const form = document.getElementById("request-form");
      const ackSection = document.getElementById("ack");
      const statusSection = document.getElementById("status");
      const errorBox = document.getElementById("error");
      let pollHandle = null;

      function resetStatusView() {
        document.getElementById("request-id").textContent = "—";
        document.getElementById("ack-ms").textContent = "—";
        document.getElementById("status-value").textContent = "pending";
        document.getElementById("status-provider").textContent = "—";
        document.getElementById("status-latency").textContent = "—";
        document.getElementById("status-cache").textContent = "—";
        errorBox.textContent = "";
        errorBox.hidden = true;
      }

      function renderStatus(payload) {
        document.getElementById("status-value").textContent = payload.status;
        document.getElementById("status-provider").textContent = payload.provider;
        document.getElementById("status-cache").textContent = payload.cache_hit ? "yes" : "no";
        document.getElementById("status-latency").textContent =
          payload.latency_ms === null || payload.latency_ms === undefined
            ? "pending"
            : `${payload.latency_ms.toFixed(1)} ms`;
        statusSection.hidden = false;
      }

      async function pollStatus(id) {
        try {
          const response = await fetch(`/requests/${id}`);
          if (!response.ok) {
            throw new Error("Failed to load status");
          }
          const payload = await response.json();
          renderStatus(payload);
          if (payload.status !== "done") {
            pollHandle = setTimeout(() => {
              pollStatus(id).catch((error) => showError(error));
            }, 750);
          }
        } catch (error) {
          showError(error);
        }
      }

      function showError(error) {
        errorBox.textContent = error?.message || "Unexpected error";
        errorBox.hidden = false;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (pollHandle) {
          clearTimeout(pollHandle);
          pollHandle = null;
        }
        resetStatusView();
        ackSection.hidden = false;
        const prompt = document.getElementById("prompt").value.trim();
        if (!prompt) {
          showError(new Error("Prompt is required"));
          return;
        }
        const provider = document.getElementById("provider").value;
        try {
          const start = performance.now();
          const response = await fetch("/requests", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, provider }),
          });
          const ackLatency = performance.now() - start;
          document.getElementById("ack-ms").textContent = ackLatency.toFixed(1);
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            const message = payload.detail || response.statusText || "Unable to submit request";
            throw new Error(message);
          }
          const data = await response.json();
          document.getElementById("request-id").textContent = data.id;
          await pollStatus(data.id);
        } catch (error) {
          showError(error);
        }
      });
    </script>
  </body>
</html>
